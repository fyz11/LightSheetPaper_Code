# -*- coding: utf-8 -*-
"""
Created on Thu Oct 16 15:31:11 2014

@author: felix

Description:
    Evaluates the dense optical flow between two consecutive image frames for the first image
    
Usage:

    
"""

def Eval_dense_optic_flow(prev, present, params):
    
    """
    Input:
        prev: previous frame, m x n image
        present: current frame, m x n image
        params: a dict object to pass all algorithm parameters.
            fields are the same as that in opencv docs:
            recommended starting values:
            
            params['pyr_scale'] = 0.5
            params['levels'] = 3
            params['winsize'] = 15
            params['iterations'] = 3
            params['poly_n'] = 5
            params['poly_sigma'] = 1.2
            params['flags'] = 0
        
    Output:
        flow: finds the displacement field between frames, prev and present such that
                prev(y,x) = next(y+flow(y,x)[1], x+flow(y,x)[0])
        where (x,y) is the cartesian coordinates of the image.
    """
    
    import numpy as np 
    import warnings
    import cv2

    # Check version of opencv installed, if not 3.0.0 then issue alert.
#    if '3.0.0' in cv2.__version__ or '3.1.0' in cv2.__version__:
        # Make the image pixels into floats.
    prev = prev.astype(np.float)
    present = present.astype(np.float)

    flow = cv2.calcOpticalFlowFarneback(prev, present, None, params['pyr_scale'], params['levels'], params['winsize'], params['iterations'], params['poly_n'], params['poly_sigma'], params['flags']) 
#    flow = cv2.calcOpticalFlowFarneback(prev, present, pyr_scale=params['pyr_scale'], levels=params['levels'], winsize=params['winsize'], iterations=params['iterations'], poly_n=params['poly_n'], poly_sigma=params['poly_sigma'], flags=params['flags']) 
    
    return flow
    
    
def Eval_dense_optic_flow_mask(prev, present, params):
    
    """
    Input:
        prev: previous frame, m x n image
        present: current frame, m x n image
        params: a dict object to pass all algorithm parameters.
            fields are the same as that in opencv docs:
            recommended starting values:
            
            params['pyr_scale'] = 0.5
            params['levels'] = 3
            params['winsize'] = 15
            params['iterations'] = 3
            params['poly_n'] = 5
            params['poly_sigma'] = 1.2
            params['flags'] = 0
        
    Output:
        flow: finds the displacement field between frames, prev and present such that
                prev(y,x) = next(y+flow(y,x)[1], x+flow(y,x)[0])
        where (x,y) is the cartesian coordinates of the image.
    """
    
    import numpy as np 
    import warnings
    import cv2

    # Check version of opencv installed, if not 3.0.0 then issue alert.
#    if '3.0.0' in cv2.__version__ or '3.1.0' in cv2.__version__:
        # Make the image pixels into floats.
    prev = prev.astype(np.float)
    present = present.astype(np.float)

    flow = cv2.calcOpticalFlowFarneback(prev, present, None, params['pyr_scale'], params['levels'], params['winsize'], params['iterations'], params['poly_n'], params['poly_sigma'], params['flags']) 
#    flow = cv2.calcOpticalFlowFarneback(prev, present, pyr_scale=params['pyr_scale'], levels=params['levels'], winsize=params['winsize'], iterations=params['iterations'], poly_n=params['poly_n'], poly_sigma=params['poly_sigma'], flags=params['flags']) 
    
    return flow

